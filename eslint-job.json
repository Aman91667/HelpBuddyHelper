[{"filePath":"C:\\Users\\amanj\\Desktop\\New folder\\helpers\\src\\pages\\JobPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1324,1327],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1324,1327],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1620,1623],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1620,1623],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":36,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'navigate' and 'toast'. Either include them or remove the dependency array.","line":40,"column":6,"nodeType":"ArrayExpression","endLine":40,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [navigate, serviceId, toast]","fix":{"range":[1698,1709],"text":"[navigate, serviceId, toast]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1791,1794],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1791,1794],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":88,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":88,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":92,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3707,3710],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3707,3710],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":95,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":101,"column":68,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":69},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":102,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":102,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":111,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4258,4261],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4258,4261],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":123,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":123,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":126,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":126,"endColumn":19},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'no-console').","line":139,"column":11,"severity":1,"nodeType":null,"fix":{"range":[5181,5219],"text":" "}},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'serviceId'. Either include it or remove the dependency array.","line":153,"column":6,"nodeType":"ArrayExpression","endLine":153,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [helperId, serviceId]","fix":{"range":[5785,5795],"text":"[helperId, serviceId]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":243,"column":102,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":243,"endColumn":105,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9073,9076],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9073,9076],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":243,"column":146,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":243,"endColumn":149,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9117,9120],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9117,9120],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":259,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":259,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10018,10021],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10018,10021],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":267,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":267,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10521,10524],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10521,10524],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":267,"column":132,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":267,"endColumn":135,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10574,10577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10574,10577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":276,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":276,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10969,10972],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10969,10972],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":288,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11859,11862],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11859,11862],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":288,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11900,11903],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11900,11903],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":20,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { useEffect, useState, useRef } from 'react';\r\nimport { useParams, useNavigate } from 'react-router-dom';\r\nimport CurrentJobCard from '@/features/jobs/components/CurrentJobCard';\r\nimport { apiClient } from '@/lib/apiClient';\r\nimport { socketClient } from '@/lib/socketClient';\r\nimport type { Service } from '@/types';\r\nimport { useToast } from '@/hooks/use-toast';\r\nimport { Map } from '@/components/Map';\r\n\r\nexport default function JobPage() {\r\n  const { serviceId } = useParams<{ serviceId: string }>();\r\n  const navigate = useNavigate();\r\n  const { toast } = useToast();\r\n  const [service, setService] = useState<Service | null>(null);\r\n  const [patientLocation, setPatientLocation] = useState<{ lat: number; lng: number } | null>(null);\r\n  const [helperId, setHelperId] = useState<string | null>(null);\r\n  const [otp, setOtp] = useState('');\r\n  const [otpVerified, setOtpVerified] = useState<boolean>(false);\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      if (!serviceId) return;\r\n      try {\r\n        const res = await apiClient.getService(serviceId);\r\n        if (res && res.success && res.data) {\r\n          setService(res.data as Service);\r\n        } else {\r\n          // show error and navigate away instead of staying stuck on loading\r\n          toast({ title: 'Failed to load job', description: (res as any)?.error || 'Service not found' });\r\n          navigate('/dashboard');\r\n          return;\r\n        }\r\n        // fetch helper profile so we can send live location updates\r\n        const me = await apiClient.getHelperProfile();\r\n        if (me && me.success && me.data) setHelperId((me.data as any).id);\r\n      } catch (err) {\r\n        // ignore\r\n      }\r\n    })();\r\n  }, [serviceId]);\r\n\r\n  useEffect(() => {\r\n    if (service) {\r\n      setOtpVerified(!!(service as any).otpVerified);\r\n    }\r\n  }, [service]);\r\n\r\n  // helper's own geolocation position (used to compute distance to patient)\r\n  const [helperPosition, setHelperPosition] = useState<{ lat: number; lng: number } | null>(null);\r\n  const lastEmitRef = useRef<number>(0);\r\n  const emitInterval = 1000; // 1s\r\n  useEffect(() => {\r\n    let watcher: number | null = null;\r\n    if (navigator.geolocation) {\r\n      watcher = navigator.geolocation.watchPosition((p) => {\r\n        setHelperPosition({ lat: p.coords.latitude, lng: p.coords.longitude });\r\n      });\r\n    }\r\n    return () => {\r\n      if (watcher != null && navigator.geolocation) navigator.geolocation.clearWatch(watcher);\r\n    };\r\n  }, []);\r\n\r\n  // listen for patient location updates over realtime socket\r\n  useEffect(() => {\r\n    const handlePatientLocation = (data: { lat: number; lng: number; serviceId?: string }) => {\r\n      if (!data) return;\r\n      if (import.meta.env.DEV) console.debug('[HELPER] patient location', data);\r\n      setPatientLocation({ lat: data.lat, lng: data.lng });\r\n    };\r\n\r\n    socketClient.on('patient:location', handlePatientLocation);\r\n    return () => {\r\n      socketClient.off('patient:location', handlePatientLocation);\r\n    };\r\n  }, []);\r\n\r\n  // Join the service-specific socket room so we receive broadcasts to `service:{id}`\r\n  useEffect(() => {\r\n    if (!serviceId) return;\r\n    try {\r\n      // Ensure a socket is connected (use stored accessToken) before joining\r\n      const token = localStorage.getItem('accessToken') || '';\r\n      if (token) socketClient.connect(token);\r\n      // persist active service id so socket can rejoin after HMR reconnects\r\n      try {\r\n        localStorage.setItem('activeServiceId', String(serviceId));\r\n      } catch (e) {\r\n        // ignore storage errors\r\n      }\r\n      // join with ack callback for client-side confirmation\r\n      socketClient.emit('join:service', { serviceId }, (ack?: any) => {\r\n        if (import.meta.env.DEV) console.debug('[JOIN DEBUG]', { serviceId, ack });\r\n      });\r\n    } catch (e) {\r\n      // ignore\r\n    }\r\n    return () => {\r\n      try {\r\n        socketClient.emit('leave:service', { serviceId });\r\n        try { localStorage.removeItem('activeServiceId'); } catch (e) { /* ignore */ }\r\n      } catch (e) {\r\n        // ignore\r\n      }\r\n    };\r\n  }, [serviceId]);\r\n\r\n  // send helper location periodically while on job page\r\n  useEffect(() => {\r\n    let watcherId: number | null = null;\r\n    let intervalId: any = null;\r\n    const sendLocation = async (lat: number, lng: number) => {\r\n      try {\r\n        if (!helperId) return;\r\n        await apiClient.updateLocation(helperId as string, lat, lng);\r\n        try {\r\n          // throttle socket emits to once per second\r\n          const now = Date.now();\r\n          if (now - lastEmitRef.current >= emitInterval) {\r\n            lastEmitRef.current = now;\r\n            socketClient.emit('helper:location:update', { serviceId, lat, lng });\r\n          }\r\n        } catch (e) {\r\n          // ignore socket errors\r\n        }\r\n      } catch (err) {\r\n        // ignore\r\n      }\r\n    };\r\n\r\n    if (navigator.geolocation) {\r\n      // try a watchPosition first\r\n      watcherId = navigator.geolocation.watchPosition(\r\n        (pos) => {\r\n          sendLocation(pos.coords.latitude, pos.coords.longitude);\r\n        },\r\n        (err) => {\r\n          // fallback to interval polling\r\n          // eslint-disable-next-line no-console\r\n          console.warn('[JobPage] geolocation watch failed, falling back to polling', err);\r\n          intervalId = setInterval(async () => {\r\n            navigator.geolocation.getCurrentPosition((p) => sendLocation(p.coords.latitude, p.coords.longitude));\r\n          }, 5000);\r\n        },\r\n        { enableHighAccuracy: true, maximumAge: 2000, timeout: 5000 }\r\n      );\r\n    }\r\n\r\n    return () => {\r\n      if (watcherId != null && navigator.geolocation) navigator.geolocation.clearWatch(watcherId);\r\n      if (intervalId) clearInterval(intervalId);\r\n    };\r\n  }, [helperId]);\r\n\r\n  const handleMarkArrived = async () => {\r\n    if (!serviceId) return;\r\n    if (!otpVerified) {\r\n      toast({ title: 'OTP required', description: 'Verify OTP from patient before marking arrival.' });\r\n      return;\r\n    }\r\n\r\n    const res = await apiClient.markArrived(serviceId);\r\n    if (res && res.success) {\r\n      toast({ title: 'Marked arrived' });\r\n      // refresh\r\n      const r = await apiClient.getService(serviceId);\r\n      if (r && r.success) setService(r.data as Service);\r\n    } else {\r\n      toast({ title: 'Failed', description: res?.error || 'Could not mark arrived' });\r\n    }\r\n  };\r\n\r\n  const handleVerifyOtp = async () => {\r\n    if (!serviceId || !otp) return;\r\n    const res = await apiClient.verifyServiceOtp(serviceId, otp);\r\n    if (res && res.success) {\r\n      setOtpVerified(true);\r\n      // refresh service state\r\n      const r = await apiClient.getService(serviceId);\r\n      if (r && r.success) setService(r.data as Service);\r\n      toast({ title: 'OTP verified' });\r\n    } else {\r\n      toast({ title: 'Invalid OTP', description: res?.error || 'Verification failed' });\r\n    }\r\n  };\r\n\r\n  const handleComplete = async () => {\r\n    if (!serviceId) return;\r\n    const res = await apiClient.completeService(serviceId);\r\n    if (res && res.success) {\r\n      toast({ title: 'Service completed' });\r\n      navigate('/dashboard');\r\n    } else {\r\n      toast({ title: 'Failed', description: res?.error || 'Could not complete' });\r\n    }\r\n  };\r\n\r\n  const handleRelease = async () => {\r\n    if (!serviceId) return;\r\n    // Only allow release if OTP not verified\r\n    if (otpVerified) {\r\n      toast({ title: 'Cannot release', description: 'Job cannot be released after OTP verification.' });\r\n      return;\r\n    }\r\n\r\n    const res = await apiClient.releaseService(serviceId);\r\n    if (res && res.success) {\r\n      toast({ title: 'Released job' });\r\n      // refresh or navigate back to dashboard\r\n      navigate('/dashboard');\r\n    } else {\r\n      toast({ title: 'Failed to release', description: res?.error || 'Could not release job' });\r\n    }\r\n  };\r\n\r\n  if (!service) {\r\n    return (\r\n      <div className=\"min-h-screen flex items-center justify-center\">\r\n        <p>Loading job...</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Render CurrentJobCard but supply action handlers via buttons below\r\n  // compute distance between helper (local) and patientLocation when available\r\n\r\n  const distanceBetween = (a?: { lat: number; lng: number } | null, b?: { lat: number; lng: number } | null) => {\r\n    if (!a || !b) return null;\r\n    const R = 6371e3; // metres\r\n    const toRad = (deg: number) => (deg * Math.PI) / 180;\r\n    const φ1 = toRad(a.lat);\r\n    const φ2 = toRad(b.lat);\r\n    const Δφ = toRad(b.lat - a.lat);\r\n    const Δλ = toRad(b.lng - a.lng);\r\n    const aa = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\r\n    const c = 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));\r\n    const d = (R * c) / 1000; // km\r\n    return d;\r\n  };\r\n\r\n  // derive an effective patient location: prefer realtime `patientLocation` state\r\n  // but fallback to the service record's patientLocation if present.\r\n  const effectivePatientLocation = patientLocation ?? (service?.patientLocation ? { lat: (service as any).patientLocation?.lat, lng: (service as any).patientLocation?.lng } : null);\r\n  const hasPatientLocation = !!(effectivePatientLocation && typeof effectivePatientLocation.lat === 'number' && typeof effectivePatientLocation.lng === 'number');\r\n  const distKm = distanceBetween(helperPosition, effectivePatientLocation);\r\n\r\n  return (\r\n    <div className=\"min-h-screen p-6\">\r\n      <div className=\"max-w-3xl mx-auto\">\r\n        <CurrentJobCard service={service} />\r\n\r\n        {/* Map view showing helper and patient locations */}\r\n        <div className=\"mt-4 p-3 bg-muted/60 rounded-md border border-border/50\">\r\n          <p className=\"text-sm font-medium mb-2\">Live locations</p>\r\n          <div className=\"h-64 w-full rounded-md overflow-hidden\">\r\n            <Map\r\n              center={helperPosition || effectivePatientLocation}\r\n              markers={[\r\n                ...(hasPatientLocation ? [{ position: effectivePatientLocation as any, popup: 'Patient', type: 'patient' as const }] : []),\r\n                ...(helperPosition ? [{ position: helperPosition, popup: 'You', type: 'helper' as const }] : []),\r\n              ]}\r\n              height=\"100%\"\r\n            />\r\n          </div>\r\n          <div className=\"mt-2 text-sm\">\r\n            <p>Helper: {helperPosition ? `${helperPosition.lat.toFixed(6)}, ${helperPosition.lng.toFixed(6)}` : 'unknown'}</p>\r\n            <p>Patient: {hasPatientLocation ? `${(effectivePatientLocation as any).lat.toFixed(6)}, ${(effectivePatientLocation as any).lng.toFixed(6)}` : 'unknown'}</p>\r\n            {distKm != null && (\r\n              <p className=\"mt-1\">Distance to patient: {distKm.toFixed(2)} km</p>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-6 grid grid-cols-1 gap-3\">\r\n          {/* OTP verification flow: helper must verify OTP provided by patient before starting */}\r\n          {(service.status as any) === 'ACCEPTED' && (\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex gap-2\">\r\n                <input value={otp} onChange={e => setOtp(e.target.value)} placeholder=\"Enter OTP from patient\" className=\"flex-1 input input-lg\" />\r\n                <button onClick={handleVerifyOtp} className=\"btn\">Verify</button>\r\n              </div>\r\n              <div className=\"grid grid-cols-2 gap-2\">\r\n                <button disabled={!otpVerified} onClick={handleMarkArrived} className={`w-full h-12 rounded-md ${otpVerified ? 'bg-gradient-to-r from-primary to-primary-glow text-white' : 'bg-slate-200 text-muted-foreground'}`}>Mark as Arrived / Start</button>\r\n                <button onClick={handleRelease} className=\"w-full h-12 border rounded-md text-sm\">Release job</button>\r\n              </div>\r\n            </div>\r\n          )}\r\n          {((service.status as any) === 'STARTED' || (service.status as any) === 'IN_PROGRESS') && (\r\n            <button onClick={handleComplete} className=\"w-full h-12 bg-gradient-to-r from-success to-success/80 text-white rounded-md\">Complete Service</button>\r\n          )}\r\n\r\n          <button onClick={() => navigate('/dashboard')} className=\"w-full h-12 border rounded-md\">Back to dashboard</button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]}]